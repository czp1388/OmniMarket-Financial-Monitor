<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级预警管理 - 寰宇多市场金融监控系统</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            border-left: 4px solid var(--primary-color);
        }

        .header h1 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .header .subtitle {
            color: #64748b;
            font-size: 14px;
        }

        .status-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .status-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 200px;
        }

        .status-card.alert {
            border-left: 4px solid var(--danger-color);
        }

        .status-card.monitoring {
            border-left: 4px solid var(--success-color);
        }

        .status-card.rules {
            border-left: 4px solid var(--warning-color);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            color: var(--primary-color);
        }

        .card-body {
            padding: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: #f1f5f9;
            font-weight: 600;
        }

        .alert-triggered {
            background: #fef2f2;
            color: var(--danger-color);
            font-weight: 600;
        }

        .alert-monitoring {
            background: #f0fdf4;
            color: var(--success-color);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-danger {
            background: #fecaca;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px;
            border-radius: 8px;
            color: white;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .status-card {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>🚨 高级预警管理系统</h1>
            <p class="subtitle">实时监控市场价格变化，及时接收预警通知</p>
        </div>

        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="status-card monitoring">
                <h3>监控状态</h3>
                <p id="monitoring-status">加载中...</p>
            </div>
            <div class="status-card rules">
                <h3>预警规则</h3>
                <p id="rules-count">加载中...</p>
            </div>
            <div class="status-card alert">
                <h3>已触发预警</h3>
                <p id="triggered-count">加载中...</p>
            </div>
        </div>

        <!-- 预警规则列表 -->
        <div class="card">
            <div class="card-header">
                <h2>预警规则列表</h2>
                <button class="btn btn-primary" onclick="showAddRuleModal()">+ 添加预警规则</button>
            </div>
            <div class="card-body">
                <div id="rules-loading" class="loading">加载预警规则...</div>
                <table id="rules-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>交易对</th>
                            <th>条件</th>
                            <th>阈值</th>
                            <th>通知方式</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="rules-tbody">
                        <!-- 规则数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 预警历史 -->
        <div class="card">
            <div class="card-header">
                <h2>预警触发记录</h2>
            </div>
            <div class="card-body">
                <div id="history-loading" class="loading">加载预警历史...</div>
                <div id="alert-history">
                    <!-- 预警历史将通过JavaScript动态填充 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 添加预警规则模态框 -->
    <div id="addRuleModal" class="modal">
        <div class="modal-content">
            <div class="card-header">
                <h2>添加预警规则</h2>
                <button onclick="hideAddRuleModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            </div>
            <div class="card-body">
                <form id="add-rule-form">
                    <div class="form-group">
                        <label for="symbol">交易对</label>
                        <select id="symbol" required>
                            <option value="">选择交易对</option>
                            <!-- 交易对选项将通过JavaScript动态填充 -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="condition">预警条件</label>
                        <select id="condition" required>
                            <option value="">选择条件类型</option>
                            <option value="above">价格高于</option>
                            <option value="below">价格低于</option>
                            <option value="change_up">涨幅超过 (%)</option>
                            <option value="change_down">跌幅超过 (%)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="threshold">阈值</label>
                        <input type="number" id="threshold" step="0.01" required placeholder="输入预警阈值">
                    </div>
                    
                    <div class="form-group">
                        <label for="notification_type">通知方式</label>
                        <select id="notification_type">
                            <option value="log">日志记录</option>
                            <option value="console">控制台通知</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <button type="button" class="btn" onclick="hideAddRuleModal()" style="flex: 1;">取消</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">创建规则</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 通知容器 -->
    <div id="notification-container"></div>

    <script>
        // API基础URL
        const API_BASE = '/api/v1';
        
        // 全局状态
        let alertRules = [];
        let marketSymbols = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadAlertStatus();
            loadAlertRules();
            loadMarketSymbols();
            startRealTimeUpdates();
        });

        // 加载预警状态
        async function loadAlertStatus() {
            try {
                const response = await fetch(`${API_BASE}/alerts/status`);
                const data = await response.json();
                
                document.getElementById('monitoring-status').textContent = 
                    data.monitoring ? '🟢 运行中' : '🔴 已停止';
                document.getElementById('rules-count').textContent = 
                    `${data.rule_count || 0} 个规则`;
                document.getElementById('triggered-count').textContent = 
                    `${getTriggeredRulesCount()} 个预警`;
                    
            } catch (error) {
                console.error('加载预警状态失败:', error);
                showNotification('加载预警状态失败', 'error');
            }
        }

        // 加载预警规则
        async function loadAlertRules() {
            try {
                const response = await fetch(`${API_BASE}/alerts/rules`);
                alertRules = await response.json();
                renderAlertRules();
                updateStatusCounts();
                
            } catch (error) {
                console.error('加载预警规则失败:', error);
                showNotification('加载预警规则失败', 'error');
            }
        }

        // 加载市场交易对
        async function loadMarketSymbols() {
            try {
                const response = await fetch(`${API_BASE}/realtime/prices`);
                const data = await response.json();
                marketSymbols = Object.keys(data.data || {});
                populateSymbolSelect();
                
            } catch (error) {
                console.error('加载交易对失败:', error);
                // 使用默认交易对作为备选
                marketSymbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'XRP/USDT', 'ADA/USDT'];
                populateSymbolSelect();
            }
        }

        // 填充交易对选择框
        function populateSymbolSelect() {
            const select = document.getElementById('symbol');
            select.innerHTML = '<option value="">选择交易对</option>';
            
            marketSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
            });
        }

        // 渲染预警规则表格
        function renderAlertRules() {
            const tbody = document.getElementById('rules-tbody');
            const loading = document.getElementById('rules-loading');
            const table = document.getElementById('rules-table');
            
            if (alertRules.length === 0) {
                loading.innerHTML = '暂无预警规则';
                table.style.display = 'none';
                return;
            }
            
            loading.style.display = 'none';
            table.style.display = 'table';
            
            tbody.innerHTML = '';
            
            alertRules.forEach(rule => {
                const row = document.createElement('tr');
                if (rule.triggered) {
                    row.className = 'alert-triggered';
                }
                
                const conditionText = getConditionText(rule.condition);
                const statusBadge = rule.triggered ? 
                    '<span class="badge badge-danger">已触发</span>' : 
                    '<span class="badge badge-success">监控中</span>';
                
                row.innerHTML = `
                    <td>${rule.symbol}</td>
                    <td>${conditionText}</td>
                    <td>${rule.threshold}${rule.condition.includes('change') ? '%' : ''}</td>
                    <td>${getNotificationText(rule.notification_type)}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDate(rule.created_at)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteAlertRule('${rule.symbol}', '${rule.condition}', ${rule.threshold})">
                            删除
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // 获取条件文本
        function getConditionText(condition) {
            const conditions = {
                'above': '价格高于',
                'below': '价格低于',
                'change_up': '涨幅超过',
                'change_down': '跌幅超过'
            };
            return conditions[condition] || condition;
        }

        // 获取通知方式文本
        function getNotificationText(notificationType) {
            const types = {
                'log': '日志记录',
                'console': '控制台通知'
            };
            return types[notificationType] || notificationType;
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString().slice(0, 5);
        }

        // 获取已触发的规则数量
        function getTriggeredRulesCount() {
            return alertRules.filter(rule => rule.triggered).length;
        }

        // 更新状态计数
        function updateStatusCounts() {
            document.getElementById('rules-count').textContent = `${alertRules.length} 个规则`;
            document.getElementById('triggered-count').textContent = `${getTriggeredRulesCount()} 个预警`;
        }

        // 显示添加规则模态框
        function showAddRuleModal() {
            document.getElementById('addRuleModal').style.display = 'flex';
        }

        // 隐藏添加规则模态框
        function hideAddRuleModal() {
            document.getElementById('addRuleModal').style.display = 'none';
            document.getElementById('add-rule-form').reset();
        }

        // 添加预警规则
        document.getElementById('add-rule-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const ruleData = {
                symbol: document.getElementById('symbol').value,
                condition: document.getElementById('condition').value,
                threshold: parseFloat(document.getElementById('threshold').value),
                notification_type: document.getElementById('notification_type').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/alerts/rules`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ruleData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('预警规则创建成功', 'success');
                    hideAddRuleModal();
                    loadAlertRules();
                    loadAlertStatus();
                } else {
                    throw new Error('创建规则失败');
                }
            } catch (error) {
                console.error('创建预警规则失败:', error);
                showNotification('创建预警规则失败', 'error');
            }
        });

        // 删除预警规则
        async function deleteAlertRule(symbol, condition, threshold) {
            if (!confirm(`确定要删除预警规则吗？\n${symbol} ${getConditionText(condition)} ${threshold}`)) {
                return;
            }
            
            try {
                const response = await fetch(
                    `${API_BASE}/alerts/rules?symbol=${encodeURIComponent(symbol)}&condition=${encodeURIComponent(condition)}&threshold=${threshold}`, 
                    { method: 'DELETE' }
                );
                
                if (response.ok) {
                    showNotification('预警规则删除成功', 'success');
                    loadAlertRules();
                    loadAlertStatus();
                } else {
                    throw new Error('删除规则失败');
                }
            } catch (error) {
                console.error('删除预警规则失败:', error);
                showNotification('删除预警规则失败', 'error');
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // 显示动画
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 启动实时更新
        function startRealTimeUpdates() {
            // 每30秒更新一次状态
            setInterval(() => {
                loadAlertStatus();
                loadAlertRules();
            }, 30000);
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('addRuleModal');
            if (event.target === modal) {
                hideAddRuleModal();
            }
        }
    </script>
</body>
</html>
