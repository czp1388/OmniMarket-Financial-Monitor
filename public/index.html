<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寰宇多市场金融监控系统 - 专业版</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        .status-badge {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px;
        }
        .data-source {
            background: #3498db;
        }
        .version {
            background: #9b59b6;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }
        .market-data {
            grid-column: 1 / -1;
        }
        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        .price-item:last-child {
            border-bottom: none;
        }
        .symbol {
            font-weight: bold;
            color: #2c3e50;
        }
        .price {
            font-size: 1.1em;
            font-weight: bold;
        }
        .change.positive {
            color: #27ae60;
        }
        .change.negative {
            color: #e74c3c;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .connection-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }
        .connection-dot.connected {
            background: #27ae60;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .real-time-indicator {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .real-time-indicator.active {
            background: #27ae60;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .info-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .info-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }
        .info-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: rgba(255,255,255,0.8);
            font-size: 0.9em;
        }
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌍 寰宇多市场金融监控系统</h1>
            <div class="subtitle">专业版 - 实时多市场数据监控平台</div>
            <div>
                <span class="status-badge">🚀 运行中</span>
                <span class="status-badge data-source">💎 混合数据源</span>
                <span class="status-badge version">🔧 v2.4.1</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>📊 系统状态</h2>
                <div class="connection-status">
                    <div class="connection-dot" id="connectionDot"></div>
                    <span id="connectionStatus">连接中...</span>
                    <span class="real-time-indicator" id="realTimeIndicator">实时</span>
                </div>
                <div class="system-info">
                    <div class="info-item">
                        <div class="info-label">活跃连接</div>
                        <div class="info-value" id="activeConnections">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">监控交易对</div>
                        <div class="info-value" id="totalSymbols">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">数据源</div>
                        <div class="info-value" id="dataSource">混合</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">最后更新</div>
                        <div class="info-value" id="lastUpdate">--</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>🔔 系统信息</h2>
                <div id="systemMessages">
                    <div class="price-item">
                        <span>✅ 真实数据服务已连接</span>
                    </div>
                    <div class="price-item">
                        <span>🌐 WebSocket服务运行中</span>
                    </div>
                    <div class="price-item">
                        <span>💾 混合数据模式</span>
                    </div>
                    <div class="price-item">
                        <span>🚀 专业版 v2.4.1</span>
                    </div>
                </div>
            </div>

            <div class="card market-data">
                <h2>📈 实时市场数据</h2>
                <div id="marketData">
                    <div class="price-item">
                        <span class="symbol">BTC/USDT</span>
                        <span class="price">$45,000.00</span>
                        <span class="change positive">+2.5%</span>
                    </div>
                    <div class="price-item">
                        <span class="symbol">ETH/USDT</span>
                        <span class="price">$3,000.00</span>
                        <span class="change positive">+1.8%</span>
                    </div>
                    <!-- 更多数据将通过WebSocket动态加载 -->
                </div>
            </div>
        </div>

        <div class="footer">
            <p>💡 寰宇多市场金融监控系统 | 专业版 v2.4.1 | 数据更新: 实时</p>
            <p>🔗 WebSocket: ws://localhost:8000/ws/realtime | 📚 API: http://localhost:8000/docs</p>
        </div>
    </div>

    <script>
        class FinancialMonitor {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.init();
            }

            init() {
                this.connectWebSocket();
                this.startConnectionMonitor();
            }

            connectWebSocket() {
                try {
                    this.ws = new WebSocket('ws://localhost:8000/ws/realtime');
                    
                    this.ws.onopen = () => {
                        console.log('✅ WebSocket连接已建立');
                        this.updateConnectionStatus(true);
                        this.reconnectAttempts = 0;
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (error) {
                            console.error('消息解析错误:', error);
                        }
                    };

                    this.ws.onclose = () => {
                        console.log('🔌 WebSocket连接已关闭');
                        this.updateConnectionStatus(false);
                        this.scheduleReconnect();
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket错误:', error);
                        this.updateConnectionStatus(false);
                    };

                } catch (error) {
                    console.error('WebSocket连接失败:', error);
                    this.scheduleReconnect();
                }
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'connection':
                        this.showSystemMessage(`🔗 ${data.message}`);
                        break;
                    case 'market_data':
                        this.updateMarketData(data.data);
                        this.updateLastUpdate();
                        break;
                    case 'subscription':
                        this.showSystemMessage(`📋 ${data.message}`);
                        break;
                    default:
                        console.log('未知消息类型:', data);
                }
            }

            updateMarketData(marketData) {
                const container = document.getElementById('marketData');
                if (!marketData || Object.keys(marketData).length === 0) {
                    container.innerHTML = '<div class="price-item">暂无市场数据</div>';
                    return;
                }

                let html = '';
                let symbolCount = 0;

                Object.values(marketData).forEach(item => {
                    if (item && item.symbol && item.price) {
                        const changeClass = item.percentage >= 0 ? 'positive' : 'negative';
                        const changeSign = item.percentage >= 0 ? '+' : '';
                        const changeValue = item.percentage ? `${changeSign}${item.percentage.toFixed(2)}%` : '0.00%';
                        
                        html += `
                            <div class="price-item">
                                <span class="symbol">${item.symbol}</span>
                                <span class="price">$${item.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                <span class="change ${changeClass}">${changeValue}</span>
                            </div>
                        `;
                        symbolCount++;
                    }
                });

                container.innerHTML = html || '<div class="price-item">暂无有效市场数据</div>';
                document.getElementById('totalSymbols').textContent = symbolCount;
            }

            updateConnectionStatus(connected) {
                const dot = document.getElementById('connectionDot');
                const status = document.getElementById('connectionStatus');
                const indicator = document.getElementById('realTimeIndicator');

                if (connected) {
                    dot.className = 'connection-dot connected';
                    status.textContent = '已连接';
                    indicator.className = 'real-time-indicator active';
                } else {
                    dot.className = 'connection-dot';
                    status.textContent = '连接断开';
                    indicator.className = 'real-time-indicator';
                }
            }

            updateLastUpdate() {
                const now = new Date();
                document.getElementById('lastUpdate').textContent = 
                    now.toLocaleTimeString('zh-CN');
            }

            showSystemMessage(message) {
                const messagesContainer = document.getElementById('systemMessages');
                const messageElement = document.createElement('div');
                messageElement.className = 'price-item';
                messageElement.innerHTML = `<span>${message}</span>`;
                
                messagesContainer.appendChild(messageElement);
                
                // 限制消息数量
                if (messagesContainer.children.length > 10) {
                    messagesContainer.removeChild(messagesContainer.children[0]);
                }
            }

            scheduleReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
                    
                    console.log(`🔄 ${delay/1000}秒后尝试重新连接... (尝试 ${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                    
                    setTimeout(() => {
                        this.connectWebSocket();
                    }, delay);
                } else {
                    console.error('❌ 达到最大重连次数，停止重连');
                    this.showSystemMessage('❌ WebSocket连接失败，请刷新页面重试');
                }
            }

            startConnectionMonitor() {
                // 定期检查连接状态
                setInterval(() => {
                    this.updateConnectionStatus();
                }, 5000);
            }

            updateConnectionStatus() {
                // 获取当前连接状态
                fetch('http://localhost:8000/api/v1/realtime/connections')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('activeConnections').textContent = data.active_connections;
                        document.getElementById('dataSource').textContent = data.data_source === 'hybrid' ? '混合' : data.data_source;
                    })
                    .catch(error => {
                        console.error('获取连接状态失败:', error);
                    });
            }
        }

        // 页面加载完成后初始化监控系统
        document.addEventListener('DOMContentLoaded', function() {
            window.financialMonitor = new FinancialMonitor();
            
            // 初始加载市场数据
            fetch('http://localhost:8000/api/v1/realtime/prices')
                .then(response => response.json())
                .then(data => {
                    if (data.data) {
                        window.financialMonitor.updateMarketData(data.data);
                        document.getElementById('totalSymbols').textContent = data.total_symbols;
                        document.getElementById('dataSource').textContent = data.data_source === 'hybrid' ? '混合' : data.data_source;
                    }
                })
                .catch(error => {
                    console.error('初始数据加载失败:', error);
                });
        });
    </script>
</body>
</html>
